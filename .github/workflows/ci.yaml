name: EC2 Metadata Mock CI and Release

on: [push, pull_request, workflow_dispatch]

env:
  DEFAULT_GO_VERSION: ^1.15
  IS_RELEASE: ${{ github.event_name == 'push' && contains(github.ref, 'refs/tags/') }}
  IS_PUSH: ${{ github.event_name == 'push' }}
  # Skip running this stage when updating release versions as part of release prep
  # as the new Docker image wouldn't be available yet and previous commits should have already been tested.
  # Since the release prep commit will be the release commit, always run this stage when a new tag is pushed, as part of a release.
  SHOULD_TEST_HELM: ${{ !contains(github.event.head_commit.message, 'Skip Helm E2E Tests') || (github.event_name == 'push' && contains(github.ref, 'refs/tags/')) }}
  GITHUB_USERNAME: ${{ secrets.EC2_BOT_GITHUB_USERNAME }}
  GITHUB_TOKEN: ${{ secrets.EC2_BOT_GITHUB_TOKEN }}
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

jobs:

  buildAndTest:
    name: Build and Test
    runs-on: ubuntu-20.04
    steps:
    - name: Set up Go 1.x
      uses: actions/setup-go@v2
      with:
        go-version: ${{ env.DEFAULT_GO_VERSION }}

    - name: Check out code into the Go module directory
      uses: actions/checkout@v2

    - name: Build
      run: make build

    - name: Unit Tests
      run: make unit-test
    
    - name: Lints
      run: make spellcheck shellcheck

    - name: Go Report Card Tests
      run: make go-report-card-test

    - name: Readme Length Validator
      run: make validate-readme
    
    - name: Brew Sync Dry run
      run: make homebrew-sync-dry-run

    - name: License Test
      if: ${{ env.IS_PUSH == true }}
      run: make license-test

    - name: E2E Tests
      run: make e2e-test

    - name: Mock IP Count Test
      run: make helm-mock-ip-count-test

    - name: Build Release Assets
      run: make build-release-assets

    - name: Build Docker Images Linux
      run: make build-docker-images-linux

  buildWindows:
    name: Build Docker Images Windows
    runs-on: windows-2019
    steps:
    - name: Set up Go 1.x
      uses: actions/setup-go@v2
      with:
        go-version: ${{ env.DEFAULT_GO_VERSION }}

    - name: Check out code into the Go module directory
      uses: actions/checkout@v2

    - name: Build Docker Images Windows
      run: choco install make && RefreshEnv.cmd && make build-docker-images-windows
    
  release:
    name: Release
    runs-on: ubuntu-20.04
    needs: [buildAndTest]
    steps:
    - name: Set up Go 1.x
      if: ${{ env.IS_RELEASE == true }}
      uses: actions/setup-go@v2
      with:
        go-version: ${{ env.DEFAULT_GO_VERSION }}

    - name: Check out code into the Go module directory
      if: ${{ env.IS_RELEASE == true }}
      uses: actions/checkout@v2
    
    - name: Validate Release Version
      if: ${{ env.IS_RELEASE == true }}
      run: make validate-release-version

    - name: Github Release
      if: ${{ env.IS_RELEASE == true }}
      run: make release-github

    - name: Release Docker Linux
      if: ${{ env.IS_RELEASE == true }}
      run: make release-docker-linux
    
  releaseWindows:
    name: Release Windows
    runs-on: windows-2019
    needs: [buildAndTest]
    steps:
    - name: Set up Go 1.x
      if: ${{ env.IS_RELEASE == true }}
      uses: actions/setup-go@v2
      with:
        go-version: ${{ env.DEFAULT_GO_VERSION }}

    - name: Check out code into the Go module directory
      if: ${{ env.IS_RELEASE == true }}
      uses: actions/checkout@v2

    - name: Release Windows Docker Image
      if: ${{ env.IS_RELEASE == true }}
      run: choco install make && RefreshEnv.cmd && make release-docker-windows

  postRelease:
    name: Post Release
    runs-on: ubuntu-20.04
    needs: [release, releaseWindows]
    steps:
    - name: Set up Go 1.x
      if: ${{ env.IS_RELEASE == true }}
      uses: actions/setup-go@v2
      with:
        go-version: ${{ env.DEFAULT_GO_VERSION }}

    - name: Check out code into the Go module directory
      if: ${{ env.IS_RELEASE == true }}
      uses: actions/checkout@v2
    
    - name: Sync to Homebrew
      if: ${{ env.IS_RELEASE == true }}
      run: make homebrew-sync


  helmLint:
    name: Helm Lint Test
    runs-on: ubuntu-20.04
    needs: [release, releaseWindows]
    steps:
    - name: Set up Go 1.x
      if: ${{ env.IS_RELEASE == true }}
      uses: actions/setup-go@v2
      with:
        go-version: ${{ env.DEFAULT_GO_VERSION }}

    - name: Check out code into the Go module directory
      if: ${{ env.IS_RELEASE == true }}
      uses: actions/checkout@v2
    
    - name: Helm Lint Test
      if: ${{ env.IS_RELEASE == true }}
      run: make validate-release-version

  chartTests:
    name: Helm Chart Tests
    runs-on: ubuntu-20.04
    needs: [release, releaseWindows]
    strategy:
      matrix:
        k8sVersion: [1.12, 1.13, 1.14, 1.15, 1.16, 1.17, 1.18]
    steps:
    - name: Set up Go 1.x
      uses: actions/setup-go@v2
      with:
        go-version: ${{ env.DEFAULT_GO_VERSION }}

    - name: Check out code into the Go module directory
      uses: actions/checkout@v2
    
    - name: Helm Chart Tests
      if: ${{ env.SHOULD_TEST_HELM == true }}
      run: test/helm/chart-test.sh -i -k ${{ matrix.k8sVersion }}